<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <!-- <script src="https://cdn.rawgit.com/musically-ut/d3-circle-text/master/circle-text/circle-text.js"></script> -->
    <style>
      text {
        font-size: 11px;
      }
      text.parent {
        fill: #1f77b4;
      }
      text {
        font: 10px sans-serif;
      }
      /*.text {
  cursor: pointer;
}
 */
      text:hover {
        /*color: #FF0000; */
        font-weight: bold;
        stroke: #000;
        stroke-width: 0.5px;
        text-decoration: underline;
      }

      circle {
        fill: #ccc;
        stroke: #999;
        pointer-events: all;
      }
      circle.parent {
        fill: #1f77b4;
        fill-opacity: 0.1;
        stroke: steelblue;
      }
      circle.parent:hover {
        stroke: #ff7f0e;
        stroke-width: 0.5px;
      }
      circle.child {
        pointer-events: none;
      }

      /*Node hover*/
      /*.node {
    cursor: pointer;
}
.node:hover {
    stroke: #000;
    stroke-width: 1.5px;
}
.node--leaf {
    fill: white;
}
*/

      /*Circle text*/
      .label {
        font: 11px "Helvetica Neue", Helvetica, Arial, sans-serif;
        text-anchor: middle;
        text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 -1px 0 #fff;
      }

      .label,
      .node--root,
      .node--leaf {
        pointer-events: none;
      }

      .arc-path {
        visibility: hidden;
      }
    </style>
  </head>
  <body>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      var data = [
        //Country,Organisation,entityid
        {
          Country: "EUROPEAN",
          entityid: 4,
          Organisation: "OrgAA",
        },
        {
          Country: "EUROPEAN",
          entityid: 5,
          Organisation: "OrgBB",
        },
        {
          Country: "EUROPEAN",
          entityid: 6,
          Organisation: "OrgCC",
        },
        {
          Country: "EUROPEAN",
          entityid: 12,
          Organisation: "OrgDD",
        },
        {
          Country: "EUROPEAN",
          entityid: 22,
          Organisation: "OrgEE",
        },
        {
          Country: "EUROPEAN",
          entityid: 23,
          Organisation: "OrgFF",
        },
        {
          Country: "FRANCE",
          entityid: 19,
          Organisation: "OrgGG",
        },
        {
          Country: "GERMANY",
          entityid: 10,
          Organisation: "OrgHH",
        },
        {
          Country: "GERMANY",
          entityid: 11,
          Organisation: "OrgJJ",
        },
        {
          Country: "GERMANY",
          entityid: 20,
          Organisation: "OrgKK",
        },
        {
          Country: "ITALY",
          entityid: 7,
          Organisation: "OrgLL",
        },
        {
          Country: "NETHERLANDS",
          entityid: 29,
          Organisation: "OrgMM",
        },
        {
          Country: "UK",
          entityid: 3,
          Organisation: "OrgNN",
        },
        {
          Country: "UK",
          entityid: 8,
          Organisation: "OrgOO",
        },
        {
          Country: "UK",
          entityid: 14,
          Organisation: "OrgPP",
        },
        {
          Country: "UK",
          entityid: 18,
          Organisation: "OrgQQ",
        },
        {
          Country: "USA",
          entityid: 1,
          Organisation: "OrgRR",
        },
        {
          Country: "USA",
          entityid: 2,
          Organisation: "OrgSS",
        },
        {
          Country: "USA",
          entityid: 13,
          Organisation: "OrgTT",
        },
        {
          Country: "USA",
          entityid: 16,
          Organisation: "OrgUU",
        },
        {
          Country: "USA",
          entityid: 31,
          Organisation: "OrgVV",
        },
      ];

      var w = 760,
        //h = 800,
        r = 400,
        x = d3.scaleLinear().range([0, r]),
        y = d3.scaleLinear().range([0, r]),
        node,
        root,
        format = d3.format(",d");

      var focus = root,
        view;

      //Declare the D3 layout type and set accessor functions
      var pack = d3.pack().size([r, r]);
      // .children(function (d) {
      //   return d.values; // accessor for children
      // })
      // .value(function (d) {
      //   return d.values; // accessor for values
      // });

      //Declare SVG attributes
      var svg = d3
        .select("body")
        .append("svg")
        .attr("width", w)
        .attr("height", w)
        .append("g")
        .attr(
          "transform",
          "translate(" + (w - r) / 2 + "," + (w - r) / 2 + ")"
        );

      //Get data
      d3.json("data", function (error, json) {
        node = root = data;
        data.forEach(function (d) {
          d.entityid = +d.entityid; //convert string to numeric
        });

        var submissionsByCountry = d3
          .nest()
          .key(function (d) {
            return d.Country;
          })
          .key(function (d) {
            return d.Organisation;
          })
          .rollup(function (leaves) {
            return leaves.length;
          })
          .entries(data);

        var countryTotal = {
          key: "Total",
          values: submissionsByCountry,
        };

        //Build a lookup table to pass entityid to 'xlink'
        var idByOrg = {};
        data.forEach(function (d) {
          idByOrg[d.Organisation] = d.entityid;
        });

        var node = svg
          .datum(countryTotal)
          .selectAll(".node")
          .data(pack.nodes)
          .enter()
          .append("g")
          .attr("class", function (d) {
            return d.children ? "node" : "leaf node";
          });
        //Create circles
        node
          .append("circle")
          .attr("r", function (d) {
            return d.r;
          })
          .attr("class", function (d) {
            return d.children ? "parent" : "child";
          })
          .attr("cx", function (d) {
            return d.x;
          })
          .attr("cy", function (d) {
            return d.y;
          })

          .on("click", function (d) {
            zoom(node == d ? root : d), d3.event.stopPropagation();
          });

        //Label the circles/nodes
        node
          .append("svg:a")
          .attr("xlink:href", function (d) {
            //hyperlinks
            //console.log(d);
            var entityid = idByOrg[d.key]; //accessing lookup table
            return "http://www.example.com/entityform/" + entityid;
          })
          .filter(function (d) {
            //Don't show Country names on nodes
            return !d.children; //(use d3-circle-text to place along arc)
          })
          .attr("target", "_blank")
          .append("text")
          .attr("dy", ".3em")
          .style("text-anchor", "middle")
          .attr("dy", ".3em")
          .style("text-anchor", "middle")
          .attr("x", function (d) {
            return d.x;
          })
          .attr("y", function (d) {
            return d.y;
          })
          .text(function (d) {
            if (d.key.length > 10) {
              return d.key.substring(0, 10) + "...";
            } else {
              return d.key;
            }
          });

        //Tooltip
        node.append("title").text(function (d) {
          return d.key + (!d.children ? "" : ": " + format(d.value));
        });

        ////////////Circle text
        var circleText = d3
          .circleText()
          .radius(function (d) {
            return d.r - 5;
          })
          .value(function (d) {
            return d.key; //Get lables
          })
          .method("align")
          .spacing("exact")
          .precision(0.1)
          .fontSize("100%");

        var gTexts = svg
          .selectAll("g.label")
          .data(pack.nodes) //Returns names
          .enter()
          .append("g")
          .classed("label", true)
          .attr("transform", function (d) {
            return "translate(" + d.x + "," + d.y + ")";
          });

        //.attr("x", function (d) { return d.x; }) // An attempt - not working
        //.attr("y", function (d) { return d.y; });

        //.attr("cx", function (d) { return d.x; }) // An attempt - not working
        //.attr("cy", function (d) { return d.y; });

        gTexts
          .filter(function (d) {
            //Only put on 'parent' circles
            return !!d.children;
          })
          .call(circleText);
        //.style('fill', 'white');

        //Reset when click on background
        svg.on("click", function (d, i) {
          zoom(d);
        });
      });

      //Add zooming
      //based on http://bl.ocks.org/mbostock/7607535 and http://bl.ocks.org/nilanjenator/4950148

      function zoom(d, i) {
        var k = r / d.r / 2;
        x.domain([d.x - d.r, d.x + d.r]);
        y.domain([d.y - d.r, d.y + d.r]);

        var t = svg.transition().duration(d3.event.altKey ? 7500 : 750);

        t.selectAll("circle")
          .attr("cx", function (d) {
            return x(d.x);
          })
          .attr("cy", function (d) {
            return y(d.y);
          })
          .attr("r", function (d) {
            return k * d.r;
          });

        t.selectAll("text")
          .attr("x", function (d) {
            return x(d.x);
          })
          .attr("y", function (d) {
            return y(d.y);
          })
          .style("opacity", function (d) {
            return k * d.r > 20 ? 1 : 0;
          });

        node = d;
        d3.event.stopPropagation();
      }

      d3.select(self.frameElement).style("height", w + "px");
    </script>
  </body>
</html>
